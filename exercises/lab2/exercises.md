## Exercise 2. 
Look at chapters 5 and 6 of the Intel 80386 Reference Manual, if you haven't done so already. Read the sections about page translation and page-based protection closely (5.2 and 6.4). We recommend that you also skim the sections about segmentation; while JOS uses paging for virtual memory and protection, segment translation and segment-based protection cannot be disabled on the x86, so you will need a basic understanding of it.

#### [分段和分页机制](http://blog.csdn.net/scucj/article/details/4267279)
分段单元把逻辑地址转换成线性地址。由于段选择符的高14位(13位索引号和1位TI位)是用来进行段描述符选择的，因此虚拟存储器中的段数最大可到16K(2的14次方)个；由于偏移量位长度为32位，那么每个段的最大地址空间可达到4GB，所以虚拟地址空间的容量大小为640TB(16K*4GB).TI标志把64 TB的地址空间分成全局地址和局部地址两个空间，分别为32 TB, TI位为0时，访问的是全局地址空间；TI位为1时，访问的是局部地址空间。通常在定义一个GDT，所有任务共享全局地址空间，如果每个进程除了在GDT中存放段外，还需要创建附加的段，则可以创建LDT，独立占有局部地址空间。GDT在内存中的地址和大小存放在gdtr控制寄存器中，当前正在被使用的LDT地址和大小放在ldtr控制寄存器中。

**一个逻辑地址如何转换成相应的线性地址。分段单元执行了以下操作：**
> 1. 检查段选择符中的TI字段，以此决定段描述符保存在哪一个描述符表中(GDT还是LDT中)。
> 2. 段选择符的索引字段乘以8，计算段描述符在描述符表(GDT 或者 LDT，由上一步决定)中的相对地址。描述符表的首地址保存在gdtr控制寄存器或者ldtr控制寄存器中(保存在哪一个寄存器中由上一步决定)。
> 3. 段描述中的base字段的值就是段基地址，加上逻辑地址，就得到了线性地址。

为了加快逻辑地址到线性地址的转换，80X86处理器提供的一种附加的非编程的寄存器，用来装64位的段描述符。每当一个段选择符被装入段寄存器时，相应的段描述符就由内存装入到对应的非编程的CPU寄存器中。只要段寄存器的内部不发生变化，就不需要执行上述步骤(1)(2)来获得线性地址,只需要执行步骤(3)即可。

分页单元把线性地址转换成物理地址。在虚地址保护方式下(即控制寄存器CR0 的PE 位为1)，控制寄存器CR0 中的最高位PG来决定是否启动分页机制，当PG＝1，分页机制有效，可以把线性地址转换为物理地址；当PG＝0，分页机制无效，线性地址就直接作为物理地址使用了。32位的线性地址被分成3个部分：最高10位为页目录索引，中间10位页表索引，最低12位偏移量。线性地址的转换分为两步，都基于转换表，第一步的转换表称为页目录表(page directory)，第二步的转换表成为页表(page table)。

线性地址被分为以固定长度为单位的组，称为页(page);分页单元把所有的RAM分成固定的长度的组，称为页框(page frame)。每个页框与页打的长度一致，一个页框包含一个页。页框是存储器中的一部分；而页是一个逻辑上的概念，它既指一组线性地址，也指包含在这组地址中的数据，页包含的数据既可以在存储器中，也可以在磁盘中。

**一个线性地址如何转换成相应的物理地址。分页单元执行了以下操作：**
> 1. 页目录基地址寄存器CR3提供页目录的页框地址(即页目录基地址)，以页目录基地址为开始，加上线性地址中的页目录索引的值，就在页目录表中找到页目录项，从页目录项中可可以得到页表的基地址值(它的低12位为0)。
> 2. 以页表的基地址值开始，加上线性地址中的页表索引的值，得到页框的物理地址(也就是页框的首物理地址)。页框的物理地址加上线性地址的偏移量，就得到了线性地址在页框内的物理地址。

进行一次地址转换需要访问两次内存：一次访问页目录表，一次访问页表。为了加速地址转换过程，80386在芯片内部设置了一个称为转换后援缓冲器TLB(Translation Lookside Buffer)的部件，如图下图所示。TLB的每项存放着32个线性地址值((线性地址的高20位,即页的基地址)和对应的物理地址值(物理地址的高20位，即页框的基地址)，另外还包含页的访问权等属性。当线性地址在转换时，将线性地址的高20位与TLB中的线性地址的值比较。如果找不到，，通过上面的转换方式计算出对应的物理地址，同时该物理地址被存在一个TLB的表项中；如果能找到则可以得到页框的基地址，加上线性地址的低12位即可得到物理地址。由于TLB具有32项，能表示出当前常用的32个页与页框的对应关系，而每页为4KB，因此TLB实际上表示出128K个((32*4KB＝128KB))线性地址和物理地址的对应关系。由于程序和数据具有局限性，而TLB中可容纳128K个地址的转换信息，利用TLB进行地址转换有极高的命中率，一般可达98%左右。当CPU的控制寄存器CR3的值被修改时，硬件自动使得TLB的所有的项都无效，因为新的一组页表开始使用了。这样以后对同一个线性地址的转化可以快速得到。
